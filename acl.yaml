---
metadata:
  namespace: default
  type: AccessPolicies.omni.sidero.dev
  id: access-policy
spec:
  usergroups:
    admins:
      users:
        - match: matjah*
    team-a:
      users:
        - match: charlie@matjah.dev
        - match: alice@matjah.dev
    team-b:
      users:
        - match: bob@matjah.dev
        - match: dave@matjah.dev
  clustergroups:
    lab:
      clusters:
        - name: auto-scale
    rumc:
      clusters:
        - name: talos-default
  rules:
    - users:
        - group/admins
      clusters:
        - group/lab
        - group/rumc
      role: Admin

    - users:
        - group/team-a
      clusters:
        - group/rumc
      role: None
      kubernetes:
        impersonate:
          groups:
            - team-a-admins

    - users:
        - group/team-b
      clusters:
        - group/rumc
      role: None
      kubernetes:
        impersonate:
          groups:
            - team-b-admins

  tests:
    - name: team-a has None role on talos-default
      user:
        name: alice@matjah.dev
      cluster:
        name: talos-default
      expected:
        role: None
        kubernetes:
          impersonate:
            groups:
              - team-a-admins
    - name: team-a has no access to lab cluster
      user:
        name: alice@matjah.dev
      cluster:
        name: auto-scale
      expected:
        role: None
        kubernetes:
          impersonate:
            groups: []
    - name: admin has Admin role on all clusters
      user:
        name: matjah@matjah.dev
      cluster:
        name: talos-default
      expected:
        role: Admin
